CREATE GENERATOR GEN_APPT_WAIT_LIST_ID;

SET TERM ^ ;
ALTER PROCEDURE WSP_TICKET_MAINTENANCE
AS
DECLARE VARIABLE vHeaderID INTEGER;
  DECLARE VARIABLE vEmail VARCHAR(50);
  DECLARE VARIABLE vUser VARCHAR(50);
  DECLARE VARIABLE vSubject VARCHAR(100);
  DECLARE VARIABLE vMessage blob SUB_TYPE text;
  DECLARE VARIABLE vKey VARCHAR(10);
  DECLARE VARIABLE vID INTEGER; -- not used
  DECLARE VARIABLE vDepartment VARCHAR(25);
BEGIN
/*
  FOR 
    SELECT th.ID, th.CREATED_BY, th.CREATED_BY_EMAIL, td.DESCRIPTION, th.TICKET_KEY, th.SUBJECT
    FROM WS_TICKET_HEADER th
      INNER JOIN WS_TICKET_DEPARTMENT td ON (td.ID = th.DEPARTMENT)
    WHERE ((th.STATUS = 3)
      AND ((CURRENT_DATE -7) > CAST(th.LAST_UPDATED AS DATE)))
    INTO :vHeaderID, :vUser, :vEmail, :vDepartment, :vKey, :vSubject
  DO
  BEGIN
    -- insert record into ticket to say closed automatically
    INSERT INTO WS_TICKET_BODY (HEADER_ID, CONTENT, CREATE_DATE, USER_NAME)
    VALUES (:vHeaderID, 'Automatically closed as on Hold for 7 days', CURRENT_TIMESTAMP, 'Heaven - System');
    vMessage = vUser || '

Your ticket has been automatically closed as it has now been on hold for more than 7 days.

Ticket Information:
Ticket Key: ' || vKey || '
Subject: ' || vSubject || '
Department: ' || vDepartment || '

You can re-open, check the status or reply to this ticket online by visiting

http://www.heavenskincare.com/Helpdesk/Tickets/ShowTicket.aspx?TicketID=' || vKey || '&Email=' || vEmail || '

Please let us know if we can assist you any further,

Heaven Health & Beauty Ltd';
    EXECUTE PROCEDURE WSP_EMAIL_INSERT(vUser, vEmail, 'Heaven SysAdmin', 'noreply@heavenbydeborahmitchell.co.uk', '[' || vKey || '] - ' || vSubject, vMessage, 2) RETURNING_VALUES vID;
    -- update the header
    UPDATE WS_TICKET_HEADER a
    SET a.STATUS = 2
    WHERE a.ID = :vHeaderID;
  END
  
  */
END^
SET TERM ; ^

GRANT EXECUTE ON PROCEDURE WSP_TICKET_MAINTENANCE TO PUBLIC;


SET TERM ^ ; 

CREATE OR ALTER PROCEDURE WSP_ROUTINE_MAINTENANCE
AS
DECLARE VARIABLE vName VARCHAR(40);
  DECLARE VARIABLE vSendEmail CHAR(1);
  DECLARE VARIABLE vEmailSent CHAR(1);
  DECLARE VARIABLE vSenderName VARCHAR(150);
  DECLARE VARIABLE vSenderEmail VARCHAR(250);
  DECLARE VARIABLE vEmail BLOB SUB_TYPE TEXT;
  DECLARE VARIABLE vEmail2 BLOB SUB_TYPE TEXT;
  DECLARE VARIABLE vEmailSubject VARCHAR(100);
  DECLARE VARIABLE vFirstName VARCHAR(100);
    
  DECLARE VARIABLE vUserEmail VARCHAR(100);
  DECLARE VARIABLE vUserName VARCHAR(100);
  DECLARE VARIABLE vUserGUUID VARCHAR(40);
  DECLARE VARIABLE vNewID BIGINT;
  DECLARE VARIABLE vSendTime TIMESTAMP;
    
  DECLARE VARIABLE vMessagesSent BIGINT;
    
  DECLARE VARIABLE vPRODUCTGROUP INTEGER;
    
  DECLARE VARIABLE vURL VARCHAR(500);
  DECLARE VARIABLE vCount integer;
BEGIN
  EXECUTE PROCEDURE WSP_PROCEDURE_RUNNING('WSP_ROUTINE_MAINTENANCE') RETURNING_VALUES :vCount;
  
  IF (vCount = 0) THEN
  BEGIN
    DELETE FROM WS_BANNED_IP a 
    WHERE a.DATE_BANNED < CURRENT_TIMESTAMP - 30;
    
    FOR
    SELECT a.ACTIVATE_PRODUCT_GROUP
    FROM WS_CAMPAIGNS a
	WHERE (a.CAMPAIGN_START < CURRENT_TIMESTAMP) AND (a.CAMPAIGN_FINISH > CURRENT_TIMESTAMP)
	INTO :vPRODUCTGROUP
	DO
	BEGIN
        IF ((vPRODUCTGROUP IS NOT NULL) AND 
            (NOT EXISTS(SELECT a.ID FROM WS_PRODUCT_GROUP a WHERE a.SHOW_ON_WEBSITE = 'Y' AND a.ID = :vPRODUCTGROUP))) THEN
        BEGIN
            IF (EXISTS(SELECT pg.ID FROM WS_PRODUCT_GROUP pg WHERE pg.ID = :vPRODUCTGROUP)) THEN
            BEGIN
                UPDATE WS_PRODUCT_GROUP
                SET SHOW_ON_WEBSITE = 'Y'
                WHERE ID = :vPRODUCTGROUP;
            END
        END
	
	END

    
    FOR
    SELECT a.ACTIVATE_PRODUCT_GROUP
    FROM WS_CAMPAIGNS a
	WHERE (a.CAMPAIGN_FINISH < CURRENT_TIMESTAMP) AND (a.ACTIVATE_PRODUCT_GROUP > -1)
	INTO :vPRODUCTGROUP
	DO
	BEGIN
        IF ((vPRODUCTGROUP IS NOT NULL) AND 
            (EXISTS(SELECT a.ID FROM WS_PRODUCT_GROUP a WHERE a.SHOW_ON_WEBSITE = 'Y' AND a.ID = :vPRODUCTGROUP))) THEN
        BEGIN
            IF (EXISTS(SELECT pg.ID FROM WS_PRODUCT_GROUP pg WHERE pg.ID = :vPRODUCTGROUP)) THEN
            BEGIN
                UPDATE WS_PRODUCT_GROUP
                SET SHOW_ON_WEBSITE = 'N'
                WHERE ID = :vPRODUCTGROUP;
            END
        END
	
	END


    
    vMessagesSent = 0;
    FOR
    SELECT a.CAMPAIGN_NAME, a.EMAIL_SEND, a.EMAIL_SENT, a.EMAIL_SENDER, a.EMAIL_ADDRESS, a.EMAIL_MESSAGE, a.EMAIL_SUBJECT
    FROM WS_CAMPAIGNS a
	WHERE (a.CAMPAIGN_START < CURRENT_TIMESTAMP) AND (a.CAMPAIGN_FINISH > CURRENT_TIMESTAMP)
	INTO :vName, :vSendEmail, :vEmailSent, :vSenderName, :vSenderEmail, :vEmail, :vEmailSubject
	DO
	BEGIN

	IF ((vSendEmail = 'Y') AND (vEmailSent = 'N')) THEN
	BEGIN
        SELECT a.NAME_VALUE
        FROM WS_DATA a
        WHERE a.NAME = 'SITE.URL'
        INTO :vURL;
        
        
        vEmail = REPLACE(vEmail, '{campaign}', vName);
        
        IF (vEMAIL CONTAINING('{site-url}')) THEN
            vEmail = REPLACE(vEmail, '{site-url}', vURL);
        
        IF (vEMAIL CONTAINING('{site-url-short}')) THEN
            vEmail = REPLACE(vEmail, '{site-url-short}', REPLACE(REPLACE(LOWER(vURL), 'https://', ''), 'http://', ''));
        
        FOR 
            SELECT a.EMAIL, a.NAME, a.NAME, a.USER_GUUID
            FROM WS_MAIL_SUBSCRIBERS a
            UNION ALL
            SELECT m.EMAIL, m.USERNAME, m.FIRSTNAME, m.USER_GUUID
            FROM WS_MEMBERS m
            WHERE (m.RECEIVE_EMAIL_SPECIAL_OFFERS = 'T')
              AND (m.EMAIL CONTAINING('@'))
              AND (UPPER(m.EMAIL) NOT CONTAINING('AOL.COM'))
        INTO :vUserEmail, :vUserName, :vFirstName, :vUserGUUID
        DO
        BEGIN 
            
            vNewID = GEN_ID(GEN_WS_EMAIL_ID, 1);
            
            vEmail2 = vEmail;
            
            IF (vEmail2 CONTAINING('{username')) THEN
                vEmail2 = REPLACE(vEmail2, '{username}', vFirstName);
            
            IF (vEmail2 CONTAINING('{UserGUUID}')) THEN
                vEmail2 = REPLACE(vEmail2, '{UserGUUID}', vUserGUUID);
    
            
            IF (MOD(vMessagesSent, 1000) = 0) THEN
            BEGIN
                vSendTime = vSendTime + (5.00000000/1440);
            END
    
            INSERT INTO WS_EMAIL(
                ID,
                TO_NAME, 
                TO_EMAIL, 
                FROM_NAME, 
                FROM_MAIL, 
                SUBJECT, 
                MAIL_MESSAGE, 
                PRIORITY, 
                QUEUE_DATE,
                SEND_DATE_TIME
            ) VALUES (
                :vNewID,
                :vUserName, 
                :vUserEmail, 
                :vSenderName,  
                :vSenderEmail, 
                :vEmailSubject, 
                :vEmail2, 
                2, 
                'NOW',
                :vSendTime
            );
            
            vMessagesSent = vMessagesSent + 1;
        END
        
        
        UPDATE WS_CAMPAIGNS SET EMAIL_SENT = 'Y' WHERE CAMPAIGN_NAME = :vName;
        END
	END
  END
  
  
  --remove old appointments
  DELETE
  FROM WS_APPOINTMENTS_CHANGES a
  WHERE a.APPOINTMENT_DATE < (SELECT CURRENT_TIMESTAMP - CAST(a.NAME_VALUE AS INTEGER)
                              FROM WS_DATA a
                              WHERE a.NAME = 'Max Appointment History');

  -- remove old web log data
  DELETE
  FROM WS_WEB_LOG a
  WHERE a.LOG_DATE < CURRENT_TIMESTAMP -365;  
  
END^

SET TERM ; ^ 


GRANT EXECUTE ON PROCEDURE WSP_ROUTINE_MAINTENANCE TO PUBLIC;



SET TERM ^ ;
ALTER PROCEDURE SPWS_APPT_WAIT_LONG_DEL (
    IPID BIGINT )
AS
BEGIN
  IF (NOT EXISTS(SELECT ID FROM WS_APPOINTMENT_WAIT_LIST_LONG WHERE ID = :ipID)) THEN
    EXCEPTION EXC_SPGEN_ERROR 'Record does not exist in table WS_APPOINTMENT_WAIT_LIST_LONG';

  DELETE FROM WS_APPOINTMENT_WAIT_LIST_LONG
  WHERE ID = :ipID;
END^
SET TERM ; ^

GRANT EXECUTE ON PROCEDURE SPWS_APPT_WAIT_LONG_DEL TO PUBLIC;

SET TERM ^ ; 

CREATE OR ALTER PROCEDURE SPWS_APPT_WAIT_LONG_GET
 (IPID INTEGER)
RETURNS
 (OPID BIGINT, 
  OPUSER_ID BIGINT, 
  OPSTAFF_ID BIGINT, 
  OPNOTES VARCHAR(8000) CHARACTER SET UTF8, 
  OPEXPIRES TIMESTAMP, 
  OPLAST_REVIEWED TIMESTAMP, 
  OPREVIEWED_BY BIGINT, 
  OPPREFERRED_DATE DATE, 
  OPPREFERRED_TIME DOUBLE PRECISION )
AS
BEGIN
  FOR
    SELECT a.ID, a.USER_ID, a.STAFF_ID, a.NOTES, a.EXPIRES, a.LAST_REVIEWED, a.REVIEWED_BY, a.PREFERRED_DATE, a.PREFERRED_TIME
    FROM WS_APPOINTMENT_WAIT_LIST_LONG a
    WHERE (a.ID = :ipID)
    ORDER BY a.EXPIRES DESC
    INTO :opID, :opUSER_ID, :opSTAFF_ID, :opNOTES, :opEXPIRES, :opLAST_REVIEWED, :opREVIEWED_BY, :opPREFERRED_DATE, :opPREFERRED_TIME
  DO
  BEGIN
    SUSPEND;
  END
END^

SET TERM ; ^ 


GRANT EXECUTE ON PROCEDURE SPWS_APPT_WAIT_LONG_GET TO PUBLIC;

DROP PROCEDURE WSF_WS_INVOICE_INS_REPLICATION;



SET TERM ^ ; 

CREATE OR ALTER PROCEDURE WSP_MAINTENANCE_ORDERS
AS
DECLARE VARIABLE vOrderID INTEGER;
  DECLARE VARIABLE vFirstName VARCHAR(50);
  DECLARE VARIABLE vFullName VARCHAR(100);
  DECLARE VARIABLE vEmail VARCHAR(100);
  DECLARE VARIABLE vMessage BLOB SUB_TYPE TEXT;
  DECLARE VARIABLE vNewID BIGINT;
BEGIN
  FOR 
    SELECT r.ID, m.FIRSTNAME, m.EMAIL, m.USERNAME
    FROM WS_INVOICE r
      INNER JOIN WS_MEMBERS m ON (m.ID = r.USERID)
    WHERE r.STATUS NOT IN (1, 6, 7, 8, 9, 11, 26)
      AND r.USER_SESSION IS NOT NULL
      AND r.REMOTE_HOST IS NOT NULL
      AND r.ID NOT IN (SELECT ORDER_ID FROM WS_INVOICE_ORDERS)
      AND r.NON_PAYMENT_REMINDER IS NULL
      AND r.PURCHASEDATE < CURRENT_TIMESTAMP -7
    INTO :vOrderID, :vFirstName, :vEmail, :vFullName
  DO
  BEGIN
    vMessage = 'Dear ' || vFirstName || ',' || '

You recently placed an order on our website but did not complete the
process by paying.

If you would like to continue with this order please follow the link
below and click "Pay Now"

http://www.heavenskincare.com/Members/Accounts/OrderViewItem.aspx?AccountsID=' || vOrderID || '

If you do not wish to complete this order then please disregard this email.

Heaven Health & Beauty Ltd';
    
    
    
    UPDATE WS_INVOICE
    SET NON_PAYMENT_REMINDER = CURRENT_TIMESTAMP
    WHERE ID = :vOrderID;
  END
  

  UPDATE WS_INVOICE r
  SET r.PROCESS_STATUS = 10, r.STATUS = 10
  WHERE r.STATUS NOT IN (1, 6, 7, 8, 9, 10, 11, 26)
    AND r.NON_PAYMENT_REMINDER < CURRENT_TIMESTAMP -7;
END^

SET TERM ; ^ 

GRANT EXECUTE ON PROCEDURE WSP_MAINTENANCE_ORDERS TO PUBLIC;

DROP PROCEDURE WSF_CREATE_ORDER_SEND_EMAIL9;

DROP PROCEDURE WSF_WS_INVOICE_INS9;

SET TERM ^ ;
ALTER PROCEDURE SPWS_APPT_WAIT_LONG_IU (
    IPID Bigint,
    IPUSER_ID Bigint,
    IPSTAFF_ID Bigint,
    IPNOTES Varchar(8000),
    IPEXPIRES Timestamp,
    IPLAST_REVIEWED Timestamp,
    IPREVIEWED_BY Bigint,
    IPPREFERRED_DATE Date,
    IPPREFERRED_TIME Double precision )
RETURNS (
    OPNEWID Bigint )
AS
BEGIN
  IF (EXISTS(SELECT ID FROM WS_APPOINTMENT_WAIT_LIST_LONG WHERE ID = :ipID)) THEN
  BEGIN
    opNEWID = ipID;

    UPDATE WS_APPOINTMENT_WAIT_LIST_LONG
    SET USER_ID = :ipUSER_ID,
      STAFF_ID = :ipSTAFF_ID,
      NOTES = :ipNOTES,
      EXPIRES = :ipEXPIRES,
      LAST_REVIEWED = :ipLAST_REVIEWED,
      REVIEWED_BY = :ipREVIEWED_BY,
      PREFERRED_DATE = :ipPREFERRED_DATE,
      PREFERRED_TIME = :ipPREFERRED_TIME
    WHERE ID = :ipID;
  END ELSE BEGIN
    opNEWID = GEN_ID(GEN_APPT_WAIT_LIST_ID, 1);

    INSERT INTO WS_APPOINTMENT_WAIT_LIST_LONG (
      ID,
      USER_ID,
      STAFF_ID,
      NOTES,
      EXPIRES,
      LAST_REVIEWED,
      REVIEWED_BY,
      PREFERRED_DATE,
      PREFERRED_TIME
    ) VALUES (
      :opNEWID,
      :ipUSER_ID,
      :ipSTAFF_ID,
      :ipNOTES,
      :ipEXPIRES,
      :ipLAST_REVIEWED,
      :ipREVIEWED_BY,
      :ipPREFERRED_DATE,
      :ipPREFERRED_TIME
    );
  END

  SUSPEND;
END^
SET TERM ; ^

GRANT EXECUTE ON PROCEDURE SPWS_APPT_WAIT_LONG_IU TO PUBLIC;


SET TERM ^ ; 

CREATE OR ALTER PROCEDURE WSP_PRODUCT_COST_COUNTRY
 (IPCOUNTRY INTEGER, 
  IPPRODUCT_ID INTEGER)
RETURNS
 (OPID BIGINT, 
  OPPRODUCT_ID BIGINT, 
  OPSKU VARCHAR(10) CHARACTER SET UTF8, 
  OPPRODUCT_SIZE VARCHAR(60) CHARACTER SET UTF8, 
  OPPRODUCT_COST DOUBLE PRECISION , 
  OPMEMBER_LEVEL INTEGER, 
  OPOUT_OF_STOCK VARCHAR(1) CHARACTER SET UTF8, 
  OPPRODUCT_TYPE INTEGER, 
  OPBARCODE VARCHAR(50) CHARACTER SET UTF8, 
  OPHIDE_GLOBALLY CHAR(1) CHARACTER SET UTF8, 
  OPIS_GIFTWRAP CHAR(1) CHARACTER SET UTF8, 
  OPPRODUCT_COST2 DOUBLE PRECISION , 
  OPPRODUCT_COST3 DOUBLE PRECISION , 
  OPDISCOUNT_VALUE DOUBLE PRECISION , 
  OPADDITIONAL_TEXT VARCHAR(100) CHARACTER SET UTF8, 
  OPIS_LICENCE CHAR(1) CHARACTER SET UTF8, 
  OPLICENCE_TYPE INTEGER, 
  OPLICENCE_COUNT INTEGER, 
  OPVAT_RATE INTEGER, 
  OPSAVING DOUBLE PRECISION )
AS
BEGIN
    FOR 
        SELECT ID, PRODUCT_ID, SKU, PRODUCT_SIZE, PRODUCT_COST, MEMBER_LEVEL, OUT_OF_STOCK, PRODUCT_TYPE, BARCODE, 
            HIDE_GLOBALLY, IS_GIFTWRAP, PRODUCT_COST2, PRODUCT_COST3, DISCOUNT_VALUE, ADDITIONAL_TEXT,
            IS_LICENCE, LICENCE_TYPE, LICENCE_COUNT, VAT_RATE, SAVING
        FROM WS_PRODUCTS_COST_SIZE 
        WHERE PRODUCT_ID = :IPPRODUCT_ID AND MEMBER_LEVEL = 0
          AND IS_DELETED = 'N'
        INTO :OPID, :OPPRODUCT_ID, :OPSKU, :OPPRODUCT_SIZE, :OPPRODUCT_COST, :OPMEMBER_LEVEL, :OPOUT_OF_STOCK, 
            :OPPRODUCT_TYPE, :opBARCODE, :opHIDE_GLOBALLY, :opIS_GIFTWRAP, :opPRODUCT_COST2, :opPRODUCT_COST3, 
            :opDISCOUNT_VALUE, :opADDITIONAL_TEXT, :opIS_LICENCE, :opLICENCE_TYPE, :opLICENCE_COUNT, :opVAT_RATE,
            :opSAVING
    DO
    BEGIN
        IF (EXISTS(SELECT PRODUCT_COST FROM WS_PRODUCT_COST_COUNTRY WHERE PRODUCT_COST_ID = :OPID AND COUNTRY_ID = :IPCOUNTRY)) THEN
        BEGIN
            SELECT PRODUCT_COST
            FROM WS_PRODUCT_COST_COUNTRY 
            WHERE PRODUCT_COST_ID = :OPID AND COUNTRY_ID = :IPCOUNTRY
            INTO :OPPRODUCT_COST;
        END
        
        SUSPEND;
    END
END^

SET TERM ; ^ 


GRANT EXECUTE ON PROCEDURE WSP_PRODUCT_COST_COUNTRY TO PUBLIC;


DROP PROCEDURE WSP_REPLICATION_STATS_CORRECT;



SET TERM ^ ; 

CREATE OR ALTER PROCEDURE SPWS_CUSTOM_PAGES_IU
 (IPID BIGINT, 
  IPPAGE_DATA BLOB SUB_TYPE 1 , 
  IPDESCRIPTION VARCHAR(1000) CHARACTER SET UTF8, 
  IPWEBSITE_ID INTEGER, 
  IPCOUNTRY_ID INTEGER, 
  IPIS_ACTIVE CHAR(1) CHARACTER SET UTF8, 
  IPPAGE_TYPE INTEGER)
RETURNS
 (OPNEWID BIGINT)
AS
BEGIN
  IF (ipPAGE_TYPE IS NULL) THEN
    EXCEPTION EXC_SPGEN_ERROR 'Column ipPAGE_TYPE in Table WS_CUSTOM_PAGES can not be null';

  IF (EXISTS(SELECT ID FROM WS_CUSTOM_PAGES WHERE ID = :ipID)) THEN
  BEGIN
    opNEWID = ipID;

    UPDATE WS_CUSTOM_PAGES
    SET PAGE_DATA = :ipPAGE_DATA,
      DESCRIPTION = :ipDESCRIPTION,
      WEBSITE_ID = :ipWEBSITE_ID,
      COUNTRY_ID = :ipCOUNTRY_ID,
      IS_ACTIVE = :ipIS_ACTIVE,
      PAGE_TYPE = :ipPAGE_TYPE
    WHERE ID = :ipID;
  END ELSE BEGIN
    opNEWID = GEN_ID(GEN_CUSTOM_PAGES_ID, 1);

    INSERT INTO WS_CUSTOM_PAGES (
      ID,
      PAGE_DATA,
      DESCRIPTION,
      WEBSITE_ID,
      COUNTRY_ID,
      IS_ACTIVE,
      PAGE_TYPE
    ) VALUES (
      :opNEWID,
      :ipPAGE_DATA,
      :ipDESCRIPTION,
      :ipWEBSITE_ID,
      :ipCOUNTRY_ID,
      :ipIS_ACTIVE,
      :ipPAGE_TYPE
    );
  END

  SUSPEND;
END^

SET TERM ; ^ 


GRANT EXECUTE ON PROCEDURE SPWS_CUSTOM_PAGES_IU TO PUBLIC;


SET TERM ^ ; 

CREATE OR ALTER PROCEDURE WSP_WS_PRODUCTS_PAGE_ADMIN
 (IPPAGESIZE BIGINT, 
  IPPAGENUMBER BIGINT)
RETURNS
 (OPID BIGINT, 
  OPNAME VARCHAR(200) CHARACTER SET UTF8, 
  OPDESCRIPTION VARCHAR(4000) CHARACTER SET UTF8, 
  OPSHOW_ON_WEB INTEGER, 
  OPIMAGE VARCHAR(300) CHARACTER SET UTF8, 
  OPSORT_ORDER INTEGER, 
  OPSPECIAL_OFFER INTEGER, 
  OPPRODUCT_GROUP INTEGER, 
  OPPOPUPID INTEGER, 
  OPSKU VARCHAR(15) CHARACTER SET UTF8, 
  OPREGAL INTEGER, 
  OPOUT_OF_STOCK VARCHAR(1) CHARACTER SET UTF8, 
  OPBEST_SELLER CHAR(1) CHARACTER SET UTF8, 
  OPNEW_PRODUCT CHAR(1) CHARACTER SET UTF8, 
  OPFEATURED CHAR(1) CHARACTER SET UTF8, 
  OPCAROUSEL CHAR(1) CHARACTER SET UTF8, 
  OPFEATURES VARCHAR(4000) CHARACTER SET UTF8, 
  OPINGREDIENTS VARCHAR(4000) CHARACTER SET UTF8, 
  OPPRE_ORDER CHAR(1) CHARACTER SET UTF8, 
  OPVIDEO_LINK VARCHAR(1000) CHARACTER SET UTF8, 
  OPHOW_TO_USE VARCHAR(2000) CHARACTER SET UTF8, 
  OPPRIMARY_GROUP_TYPE INTEGER, 
  OPFREE_SHIPPING CHAR(1) CHARACTER SET UTF8, 
  OPPAGE_LINK VARCHAR(255) CHARACTER SET UTF8, 
  OPFREE_PRODUCT VARCHAR(1) CHARACTER SET UTF8)
AS
DECLARE VARIABLE vPAGENO BIGINT;
  DECLARE VARIABLE vCOUNTER BIGINT;
BEGIN
  IF (ipPAGENUMBER < 1) THEN
    EXCEPTION ;

  IF (ipPAGESIZE < 1) THEN
    EXCEPTION ;

  vCOUNTER = 0;

  vPAGENO = (ipPAGESIZE * ipPAGENUMBER) - ipPAGESIZE;

  FOR 
  SELECT ID, NAME, DESCRIPTION, SHOW_ON_WEB, IMAGE, SORT_ORDER, SPECIAL_OFFER, PRODUCT_GROUP, 
    POPUP_ID, SKU, REGAL, OUT_OF_STOCK, BEST_SELLER, NEW_PRODUCT, FEATURED_PRODUCT, CAROUSEL, 
    FEATURES, INGREDIENTS, PRE_ORDER, VIDEO_LINK, HOW_TO_USE, PRIMARY_GROUP_TYPE, FREE_SHIPPING,
    PAGE_LINK, FREE_PRODUCT
  FROM WS_PRODUCTS
  ORDER BY NAME
  INTO :opID, :opNAME, :opDESCRIPTION, :opSHOW_ON_WEB, :opIMAGE, :opSORT_ORDER, :opSPECIAL_OFFER, 
    :opPRODUCT_GROUP, :opPOPUPID, :opSKU, :opREGAL, :opOUT_OF_STOCK, :opBEST_SELLER, :opNEW_PRODUCT, 
    :opFEATURED, :opCAROUSEL, :opFEATURES, :opINGREDIENTS, :opPRE_ORDER, :opVIDEO_LiNK, :opHOW_TO_USE,
    :OPPRIMARY_GROUP_TYPE, :opFREE_SHIPPING, :opPAGE_LINK, :opFREE_PRODUCT
  DO
  BEGIN
    IF ((vCOUNTER >= vPAGENO) AND (vCOUNTER < (vPAGENO + ipPAGESIZE))) THEN
    BEGIN
      SUSPEND;
    END

    vCOUNTER = vCOUNTER + 1;

    IF (vCOUNTER > (vPAGENO + ipPAGESIZE)) THEN
    BEGIN
      EXIT;
    END
  END
  
END^

SET TERM ; ^ 


GRANT EXECUTE ON PROCEDURE WSP_WS_PRODUCTS_PAGE_ADMIN TO PUBLIC;


ALTER DOMAIN DMN_DNF_BOOL  ADD CONSTRAINT CHECK(VALUE IN ('T', 'F')) ;



ALTER DOMAIN DMN_IP_BAN_TYPE  ADD CONSTRAINT CHECK(VALUE IN (0,1)) ;

DROP DOMAIN DMN_WS_GRADE;


ALTER DOMAIN DMN_WS_TEST_TYPE  ADD CONSTRAINT CHECK(VALUE IN (0,1)) ;


ALTER DOMAIN WS_EMAIL_ADDRESS  ADD CONSTRAINT CHECK(VALUE CONTAINING '@') ;


ALTER DOMAIN WS_MAIL_NAME  ADD CONSTRAINT CHECK(VALUE <> '') ;


ALTER DOMAIN WS_MAIL_PRIORITY  ADD CONSTRAINT CHECK(VALUE IN (1, 2, 3)) ;


ALTER DOMAIN WS_MAIL_SUBJECT  ADD CONSTRAINT CHECK(VALUE <> '') ;


ALTER DOMAIN WS_MAIL_TRY_COUNT  ADD CONSTRAINT CHECK(VALUE IN (0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)) ;


ALTER DOMAIN WS_MESSAGE_BODY  ADD CONSTRAINT CHECK(VALUE <> '') ;




SET TERM ^ ;

CREATE OR ALTER TRIGGER TR_INVOICE_ORDER_CREATE_EMAIL FOR WS_INVOICE_ORDERS ACTIVE AFTER INSERT POSITION 30
 AS 
  DECLARE VARIABLE vUserName VARCHAR(100);
  DECLARE VARIABLE vUserFirstName VARCHAR(50);
  DECLARE VARIABLE vUserEmail VARCHAR(100);
BEGIN
  IF (new.STATUS NOT IN (65, 67)) THEN
  BEGIN
    /* Find user id */
    SELECT m.EMAIL, m.USERNAME, m.FIRSTNAME
    FROM WS_MEMBERS m 
    WHERE m.ID = NEW.USERID
    INTO :vUserEMail, :vUserName, :vUserFirstName;
  
    EXECUTE PROCEDURE WSF_SYSYEM_EMAIL_CREATE(8, vUserName, vUserEMail, vUserFirstName, vUserEmail, NULL, NULL, NULL, NEW.ID, NEW.ORDER_ID);
  END
END^

SET TERM ; ^



SET TERM ^ ; 

CREATE OR ALTER PROCEDURE WD$GEO_DECODE_IP
 (IPIPADDRESS VARCHAR(15) CHARACTER SET UTF8)
RETURNS
 (OPID BIGINT, 
  OPCOUNTRY VARCHAR(3) CHARACTER SET UTF8, 
  OPCITY VARCHAR(200) CHARACTER SET UTF8, 
  OPREGION VARCHAR(3) CHARACTER SET UTF8, 
  OPPOSTCODE VARCHAR(30) CHARACTER SET UTF8, 
  OPLATITUDE BIGINT, 
  OPLONGITUDE BIGINT, 
  OPMETROCODE VARCHAR(3) CHARACTER SET UTF8, 
  OPAREACODE VARCHAR(3) CHARACTER SET UTF8, 
  OPNUMERIC BIGINT, 
  OPSTARTBLOCK BIGINT, 
  OPENDBLOCK BIGINT)
AS
DECLARE VARIABLE vIPAddressPart VARCHAR(3);
  DECLARE VARIABLE vCount INTEGER = 0;
  DECLARE VARIABLE vTotal BIGINT = 0;
  DECLARE VARIABLE vPart BIGINT = 0;
BEGIN
  FOR
    SELECT opPART
    FROM WD$SPLITSTRING(:ipIPADDRESS, '.')
    INTO :vIPAddressPart
  DO
  BEGIN
    IF (vCount = 0) THEN
        vPart = CAST(vIPAddressPart AS BIGINT) * 16777216;
    ELSE IF (vCount = 1) THEN
        vPart = CAST(vIPAddressPart AS BIGINT) * 65536;
    ELSE IF (vCount = 2) THEN
        vPart = CAST(vIPAddressPart AS BIGINT) * 256;
    ELSE 
        vPart = CAST(vIPAddressPart AS BIGINT);
  
    
    vCount = vCount + 1;
    
    vTotal = vTotal + vPart;
  END

  opNUMERIC = vTotal;
    
  SELECT FIRST 1 c.WD$COUNTRY_CODE, ipc.WD$CITY, ipc.WD$REGION, 
    ipc.WD$POSTCODE, ipc.WD$LATITUDE, ipc.WD$LONGITUDE,
    ipc.WD$METRO_CODE, ipc.WD$AREA_CODE, c.WD$FROM_IP, c.WD$TO_IP,
    ipc.WD$ID
  FROM WD$IPTOCOUNTRY c
    LEFT JOIN WD$IPCITY ipc ON (ipc.WD$ID = c.WD$CITY_ID)
  WHERE (c.WD$FROM_IP <= :vTotal) AND (c.WD$TO_IP >= :vTotal)
  ORDER BY c.WD$VERSION
  INTO :opCOUNTRY, :opCITY, :opREGION, :opPOSTCODE, :opLATITUDE, :opLONGITUDE, 
    :OPMETROCODE, :OPAREACODE, :opSTARTBLOCK, :opENDBLOCK, :opID;

  SUSPEND; 

END^

SET TERM ; ^ 

GRANT EXECUTE ON PROCEDURE WD$GEO_DECODE_IP TO PUBLIC;


SET TERM ^ ; 

CREATE OR ALTER PROCEDURE WD$GEO_DECODE_IP
 (IPIPADDRESS VARCHAR(15) CHARACTER SET UTF8)
RETURNS
 (OPID BIGINT, 
  OPCOUNTRY VARCHAR(3) CHARACTER SET UTF8, 
  OPCITY VARCHAR(200) CHARACTER SET UTF8, 
  OPREGION VARCHAR(3) CHARACTER SET UTF8, 
  OPPOSTCODE VARCHAR(30) CHARACTER SET UTF8, 
  OPLATITUDE BIGINT, 
  OPLONGITUDE BIGINT, 
  OPMETROCODE VARCHAR(3) CHARACTER SET UTF8, 
  OPAREACODE VARCHAR(3) CHARACTER SET UTF8, 
  OPNUMERIC BIGINT, 
  OPSTARTBLOCK BIGINT, 
  OPENDBLOCK BIGINT)
AS
DECLARE VARIABLE vIPAddressPart VARCHAR(3);
  DECLARE VARIABLE vCount INTEGER = 0;
  DECLARE VARIABLE vTotal BIGINT = 0;
  DECLARE VARIABLE vPart BIGINT = 0;
BEGIN
  FOR
    SELECT opPART
    FROM WD$SPLITSTRING(:ipIPADDRESS, '.')
    INTO :vIPAddressPart
  DO
  BEGIN
    IF (vCount = 0) THEN
        vPart = CAST(vIPAddressPart AS BIGINT) * 16777216;
    ELSE IF (vCount = 1) THEN
        vPart = CAST(vIPAddressPart AS BIGINT) * 65536;
    ELSE IF (vCount = 2) THEN
        vPart = CAST(vIPAddressPart AS BIGINT) * 256;
    ELSE 
        vPart = CAST(vIPAddressPart AS BIGINT);
  
    
    vCount = vCount + 1;
    
    vTotal = vTotal + vPart;
  END

  opNUMERIC = vTotal;
    
  SELECT FIRST 1 c.WD$COUNTRY_CODE, ipc.WD$CITY, ipc.WD$REGION, 
    ipc.WD$POSTCODE, ipc.WD$LATITUDE, ipc.WD$LONGITUDE,
    ipc.WD$METRO_CODE, ipc.WD$AREA_CODE, c.WD$FROM_IP, c.WD$TO_IP,
    ipc.WD$ID
  FROM WD$IPTOCOUNTRY c
    LEFT JOIN WD$IPCITY ipc ON (ipc.WD$ID = c.WD$CITY_ID)
  WHERE (c.WD$FROM_IP <= :vTotal) AND (c.WD$TO_IP >= :vTotal)
  ORDER BY c.WD$VERSION
  INTO :opCOUNTRY, :opCITY, :opREGION, :opPOSTCODE, :opLATITUDE, :opLONGITUDE, 
    :OPMETROCODE, :OPAREACODE, :opSTARTBLOCK, :opENDBLOCK, :opID;

  SUSPEND; 

END^

SET TERM ; ^ 

GRANT EXECUTE ON PROCEDURE WD$GEO_DECODE_IP TO PUBLIC;


CREATE GENERATOR GEN_PROD_TO_PROD_GROUP_ID;


SET TERM ^ ;

EXECUTE BLOCK
AS
  DECLARE VARIABLE vNEWID BIGINT;
  DECLARE VARIABLE vSQL VARCHAR(1000);
BEGIN
  SELECT GEN_ID(GEN_WS_PROD_PROD_GRP_ID, 1) + 1
  FROM RDB$DATABASE
  INTO :vNewID;
  
  EXECUTE STATEMENT 'SET GENERATOR GEN_PROD_TO_PROD_GROUP_ID TO ' || vNEWID ||';';
END ^

SET TERM ; ^



SET TERM ^ ;
ALTER TRIGGER TR_PROD_TO_PROD_GRP_ID ACTIVE
BEFORE INSERT POSITION 0
AS 
BEGIN 
    IF (NEW.ID IS NULL) THEN
        NEW.ID = GEN_ID(GEN_PROD_TO_PROD_GROUP_ID, 1);
END^
SET TERM ; ^

DROP GENERATOR GEN_WS_PROD_PROD_GRP_ID;


CREATE UNIQUE INDEX UNQ_EXPORTABLE_CONTENT_FIELDS ON EXPORTABLE_CONTENT (TABLE_NAME, COLUMN_NAME);


CREATE INDEX IDX_WD$IPTOCOUNTRY_FROM ON WD$IPTOCOUNTRY (WD$FROM_IP);


CREATE INDEX IDX_WD$IPTOCOUNTRY_TO ON WD$IPTOCOUNTRY (WD$TO_IP);



DROP TRIGGER TR_WS_ORDERS_ID;
DROP TRIGGER TR_WS_ORDERS_USER;
DROP TRIGGER TR_WS_ORDERS_USER_AFTER;
DROP PROCEDURE WSP_ORDER_CREATE;
DROP PROCEDURE WSP_ORDER_CREATE_MANUAL;
DROP TABLE WS_ORDERS;
DROP GENERATOR GEN_WS_ORDER_ID;




SET TERM ^ ;

CREATE OR ALTER TRIGGER TR_CLIENT_ACTIONS_CLOSED FOR WS_CLIENT_ACTIONS ACTIVE AFTER UPDATE POSITION 0
 AS 
  DECLARE VARIABLE vStaffName VARCHAR(100);
  DECLARE VARIABLE vStaffID BIGINT;
BEGIN 
  IF ((RDB$GET_CONTEXT('USER_TRANSACTION', 'REPLICATING') IS NULL) OR (RDB$GET_CONTEXT('USER_TRANSACTION', 'REPLICATING') = 'NO')) THEN
  BEGIN
    IF ((OLD.CLIENT_ACTION IN (1, 2)) AND (NEW.DATE_ACTIONED IS NOT NULL)) THEN
    BEGIN
        EXECUTE PROCEDURE SP_CLIENT_ACTION_CREATE(OLD.CLIENT_ACTION, OLD.CLIENT_ID) RETURNING_VALUES :vStaffID, :vStaffName;
        
        INSERT INTO WS_CLIENT_ACTIONS(CLIENT_ACTION, CLIENT_ID, EXPIRES, USER_ID, EXPECTED_BY)
        VALUES (OLD.CLIENT_ACTION, OLD.CLIENT_ID, CURRENT_TIMESTAMP + 40, :vStaffID, :vStaffName);
    END
  END
END^

SET TERM ; ^

SET TERM ^ ;
ALTER TRIGGER TR_SALONS_TO_MEMBERS_ID ACTIVE
BEFORE INSERT OR UPDATE POSITION 0
AS 
BEGIN 
	IF (NEW.ID IS NULL) THEN
        NEW.ID = GEN_ID(GEN_WS_SALONS_TO_MMBERS_ID, 1);
END^
SET TERM ; ^





SET TERM ^ ;

EXECUTE BLOCK
AS
  DECLARE VARIABLE vNEWID BIGINT;
  DECLARE VARIABLE vSQL VARCHAR(1000);
BEGIN
  SELECT GEN_ID(GEN_TEMP_STOCK_ID, 1) + 1
  FROM RDB$DATABASE
  INTO :vNewID;
  
  EXECUTE STATEMENT 'SET GENERATOR GEN_STOCK_AUDIT_ID TO ' || vNEWID ||';';
END ^

SET TERM ; ^


SET TERM ^ ;
ALTER TRIGGER TR_HS_STOCK_AUDIT_ID ACTIVE
BEFORE INSERT POSITION 0
AS 
BEGIN 
    IF (NEW.ID IS NULL) THEN
        NEW.ID = GEN_ID(GEN_STOCK_AUDIT_ID, 1);
END^
SET TERM ; ^

DROP GENERATOR GEN_TEMP_STOCK_ID;




SET TERM ^ ;

CREATE OR ALTER TRIGGER TR_TICKET_BODY_ID FOR WS_TICKET_BODY ACTIVE BEFORE INSERT POSITION 0
 AS
BEGIN
  IF (NEW.ID IS NULL OR NEW.ID < 0) THEN
    NEW.ID = GEN_ID(GEN_TICKET_BODY, 1);
    
  IF ((RDB$GET_CONTEXT('USER_TRANSACTION', 'REPLICATING') IS NULL) OR (RDB$GET_CONTEXT('USER_TRANSACTION', 'REPLICATING') = 'NO')) THEN
  BEGIN
    UPDATE WS_TICKET_HEADER SET last_replier = new.user_name, LAST_UPDATED = 'NOW' WHERE ID = new.header_ID;
  END
END^

SET TERM ; ^




SET TERM ^ ;

CREATE OR ALTER TRIGGER TR_INSERT_STOCK_STORE_TILL_ID FOR HS_STOCKCONTROL ACTIVE BEFORE INSERT POSITION 0
 AS 
BEGIN 
  IF (NEW.STORE_ID IS NULL) THEN
    NEW.STORE_ID = 0;
    
  IF (NEW.TILL_ID IS NULL) THEN
    NEW.TILL_ID = 1;
END^

SET TERM ; ^

DROP TRIGGER TR_INSERT;




SET TERM ^ ;

CREATE OR ALTER TRIGGER WD$TR_IPADDRESS_ID FOR WD$IPADDRESS ACTIVE BEFORE INSERT POSITION 0
 AS  
BEGIN  
  IF (NEW.WD$ID IS NULL) THEN 
    NEW.WD$ID = GEN_ID(WD$GEN_IPADDRESS_ID, 1); 
END^

SET TERM ; ^




SET TERM ^ ;

CREATE OR ALTER TRIGGER TR_APPT_MASTER_ID FOR WS_APPOINTMENTS ACTIVE BEFORE UPDATE POSITION 10000
 AS
BEGIN
  IF (NEW.ID IS DISTINCT FROM OLD.ID) THEN
  BEGIN
    UPDATE WS_APPOINTMENTS app
    SET app.MASTER_APPOINTMENT = NEW.ID
    WHERE app.MASTER_APPOINTMENT = OLD.ID;
  END
END^

SET TERM ; ^




SET TERM ^ ;

CREATE OR ALTER TRIGGER WD$TR_IPADDRESS_ID FOR WD$IPADDRESS ACTIVE BEFORE INSERT POSITION 0
 AS  
BEGIN  
  IF (NEW.WD$ID IS NULL) THEN 
    NEW.WD$ID = GEN_ID(WD$GEN_IPADDRESS_ID, 1); 
END^

SET TERM ; ^




SET TERM ^ ;

CREATE OR ALTER TRIGGER TR_CLIENTS_INSERT_EMAIL FOR WS_CLIENTS ACTIVE AFTER INSERT POSITION 100
 AS 
  declare variable vID BIGINT;
BEGIN 
  IF ((RDB$GET_CONTEXT('USER_TRANSACTION', 'REPLICATING') IS NULL) OR (RDB$GET_CONTEXT('USER_TRANSACTION', 'REPLICATING') = 'NO')) THEN
  BEGIN
	EXECUTE PROCEDURE WSP_EMAIL_INSERT('Liza Ward', 'liza.heavenskincare@gmail.com','no-reply', 'noreply@heavenbydeborahmitchell.co.uk','New Client Signup', NEW.CONTACT_NAME || ' Has signed up as a trade client', 1) RETURNING_VALUES :vID;
	EXECUTE PROCEDURE WSP_EMAIL_INSERT('Louise Polak', 'louisepolak.heavenskincare@gmail.com','no-reply', 'noreply@heavenbydeborahmitchell.co.uk','New Client Signup', NEW.CONTACT_NAME || ' Has signed up as a trade client', 1) RETURNING_VALUES :vID;
	EXECUTE PROCEDURE WSP_EMAIL_INSERT('Louise Ratcliff', 'louise.heavenskincare@gmail.com','no-reply', 'noreply@heavenbydeborahmitchell.co.uk','New Client Signup', NEW.CONTACT_NAME || ' Has signed up as a trade client', 1) RETURNING_VALUES :vID;
	EXECUTE PROCEDURE WSP_EMAIL_INSERT('Emily Arnold', 'emily.heavenskincare@gmail.com','no-reply', 'noreply@heavenbydeborahmitchell.co.uk','New Client Signup', NEW.CONTACT_NAME || ' Has signed up as a trade client', 1) RETURNING_VALUES :vID;
	EXECUTE PROCEDURE WSP_EMAIL_INSERT('Deborah Mitchell', 'deborah.heaven@gmail.com','no-reply', 'noreply@heavenbydeborahmitchell.co.uk','New Client Signup', NEW.CONTACT_NAME || ' Has signed up as a trade client', 1) RETURNING_VALUES :vID;
	EXECUTE PROCEDURE WSP_EMAIL_INSERT('Sales', 'sales@heavenskincare.com','no-reply', 'noreply@heavenbydeborahmitchell.co.uk','New Client Signup', NEW.CONTACT_NAME || ' Has signed up as a trade client', 1) RETURNING_VALUES :vID;
  END
END^

SET TERM ; ^





SET TERM ^ ;

CREATE OR ALTER TRIGGER TR_PRODUCTS_FREE FOR WS_PRODUCTS ACTIVE BEFORE INSERT OR UPDATE POSITION 0
 AS 
BEGIN 
    IF (NEW.FREE_PRODUCT IS NULL) THEN
        NEW.FREE_PRODUCT = 'N';
END^

SET TERM ; ^

DROP TRIGGER TR_RODUCTS_FREE;





SET TERM ^ ;

CREATE OR ALTER TRIGGER TR_WS_INVOICE_ORDERS_DISPATCHED FOR WS_INVOICE_ORDERS ACTIVE BEFORE UPDATE POSITION 7
 AS 
  DECLARE VARIABLE opEmailID BIGINT;
  DECLARE VARIABLE vUserName VARCHAR(50);
  DECLARE VARIABLE vFullName VARCHAR(100);
  DECLARE VARIABLE vEmail VARCHAR(100);
BEGIN 
  IF ((RDB$GET_CONTEXT('USER_TRANSACTION', 'REPLICATING') IS NULL) OR (RDB$GET_CONTEXT('USER_TRANSACTION', 'REPLICATING') = 'NO')) THEN
  BEGIN
      IF ((New.PROCESS_STATUS = 2) AND (NEW.PROCESS_STATUS <> OLD.PROCESS_STATUS)) THEN
      BEGIN
        NEW.PROCESS_STATUS = 2;
        New.DATE_SHIPPED = CURRENT_TIMESTAMP; 
        
        SELECT EMAIL, USERNAME, FIRSTNAME
        FROM WS_MEMBERS
        WHERE ID = NEW.USERID
        INTO :vEmail, :vFullName, :vUserName;
        
        EXECUTE PROCEDURE WSF_SYSYEM_EMAIL_CREATE(5, vFullName, vEmail, vUserName, vEmail, NULL, NULL, NULL, NULL, NEW.ORDER_ID);
      END
  END
END^

SET TERM ; ^



SET TERM ^ ;

CREATE OR ALTER TRIGGER TR_EMAIL_SENDER_DETAILS FOR WS_EMAIL ACTIVE BEFORE INSERT OR UPDATE POSITION 4
 AS 
BEGIN 
	IF ((LOWER(NEW.FROM_MAIL) <> 'optin@heavenbydeborahmitchell.com') AND (LOWER(NEW.FROM_MAIL) <> 'deborah@heavenbydeborahmitchell.com')) THEN
	BEGIN
        IF (LOWER(NEW.FROM_MAIL) <> '') THEN
        BEGIN
            NEW.FROM_MAIL = 'noreply@heavenskincare.com';
            NEW.FROM_NAME = 'noreply@heavenskincare.com';
        END
	END
END^

SET TERM ; ^




SET TERM ^ ;

CREATE OR ALTER TRIGGER TR_COST_NOTIFICATIONS_UPDATE FOR WS_PRODUCTS_COST_SIZE ACTIVE BEFORE UPDATE POSITION 32000
 AS 
  DECLARE VARIABLE vStockItem VARCHAR(200);
  DECLARE VARIABLE vMailMessage BLOB SUB_TYPE TEXT;
  DECLARE VARIABLE vSubject VARCHAR(200);
  DECLARE VARIABLE vEmail VARCHAR(150);
BEGIN 
    
  IF ((RDB$GET_CONTEXT('USER_TRANSACTION', 'REPLICATING') IS NULL) OR (RDB$GET_CONTEXT('USER_TRANSACTION', 'REPLICATING') = 'NO')) THEN
  BEGIN    
	IF (NEW.OUT_OF_STOCK = 'F' AND OLD.OUT_OF_STOCK = 'T') THEN
	BEGIN
        
        SELECT p.NAME || ' ' || pc.PRODUCT_SIZE
        FROM WS_PRODUCTS_COST_SIZE pc
            LEFT JOIN WS_PRODUCTS p ON (p.ID = pc.PRODUCT_ID)
        WHERE pc.ID = NEW.ID
        INTO :vStockItem;
	
        
        SELECT a.TEMPLATE, a.SUBJECT
        FROM WS_SYSTEM_EMAILS a
        WHERE a.ID = 13
        INTO :vMailMessage, :vSubject;
        
        
        vMailMessage = REPLACE(vMailMessage, '[STOCKITEM]', vStockItem);
        vMailMessage = REPLACE(vMailMessage, '[PRODUCTID]', NEW.PRODUCT_ID);
        vSubject = REPLACE(vSubject, '[STOCKITEM]', vStockItem);
        
        
        FOR
            SELECT a.USER_EMAIL
            FROM WS_PRODUCT_NOTIFICATIONS a
            WHERE a.PRODUCT_COST_ID = NEW.ID
            INTO :vEmail
        DO
        BEGIN
              INSERT INTO WS_EMAIL(
                ID,
                TO_NAME, 
                TO_EMAIL, 
                FROM_NAME, 
                FROM_MAIL, 
                SUBJECT, 
                MAIL_MESSAGE, 
                PRIORITY, 
                QUEUE_DATE,
                SEND_DATE_TIME    
              ) VALUES (
                GEN_ID(GEN_WS_EMAIL_ID, 1),
                :vEmail, 
                :vEmail, 
                'noreply@heavenskincare.com', 
                'noreply@heavenskincare.com', 
                :vSubject, 
                :vMailMessage, 
                1,
                CURRENT_TIMESTAMP, 
                CURRENT_TIMESTAMP
              );
        END
        
        
        DELETE 
        FROM WS_PRODUCT_NOTIFICATIONS
        WHERE PRODUCT_COST_ID = NEW.ID;
	END
  END
END^

SET TERM ; ^


