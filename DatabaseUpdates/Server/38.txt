CREATE GENERATOR GEN_HOOK_ID;
GRANT USAGE ON GENERATOR GEN_HOOK_ID TO USER PUBLIC;

CREATE TABLE SYSTEM_HOOK_NOTIFICATIONS
(
    ID BIGINT NOT NULL,
    HOOK_ID INTEGER NOT NULL,
    USER_ID BIGINT NOT NULL,
    
    CONSTRAINT IDX_SYS_HOOK_NOTIFICATIONS PRIMARY KEY (ID),
    
    CONSTRAINT FK_SYS_HOOK_USER FOREIGN KEY (USER_ID) REFERENCES WS_MEMBERS (ID) ON UPDATE CASCADE ON DELETE CASCADE
);
    
GRANT ALL ON TABLE SYSTEM_HOOK_NOTIFICATIONS TO PUBLIC;


SET TERM ^ ;

CREATE TRIGGER TR_SYS_HOOK_NOTIFY_ID FOR SYSTEM_HOOK_NOTIFICATIONS
ACTIVE BEFORE INSERT POSITION 0
AS 
BEGIN 
	IF (NEW.ID IS NULL) THEN
        NEW.ID = GEN_ID(GEN_HOOK_ID, 1);
END^

SET TERM ; ^ 

SET TERM ^ ;

EXECUTE BLOCK
AS
  DECLARE VARIABLE vNewID BIGINT;
  DECLARE VARIABLE vSiteID INTEGER;
BEGIN
  SELECT SITE_ID
  FROM REPLICATE$OPTIONS
  INTO :vSiteID;
  
  vNewID = vSiteID * 100000000;
  EXECUTE STATEMENT 'SET GENERATOR GEN_HOOK_ID TO ' || :vNewID || ';';

END ^

SET TERM ; ^


INSERT INTO REPLICATE$TABLES (TABLE_NAME, OPERATION, TRIGGER_NAME, SORT_ORDER, EXCLUDE_FIELDS, LOCAL_GENERATOR, REMOTE_GENERATOR, LOCAL_ID_COLUMN, INDICE_TYPE, OPTIONS, ID) VALUES ('SYSTEM_HOOK_NOTIFICATIONS', 'INSERT', 'SYSTEM_HOOK_NOTIF', '1000', '', 'GEN_HOOK_ID', '', 'ID', '0', '0', GEN_ID(REPLICATE$REPLICATETABLES_ID, 1));
INSERT INTO REPLICATE$TABLES (TABLE_NAME, OPERATION, TRIGGER_NAME, SORT_ORDER, EXCLUDE_FIELDS, LOCAL_GENERATOR, REMOTE_GENERATOR, LOCAL_ID_COLUMN, INDICE_TYPE, OPTIONS, ID) VALUES ('SYSTEM_HOOK_NOTIFICATIONS', 'DELETE', 'SYSTEM_HOOK_NOTIF', '1000', '', '', '', 'ID', '0', '0', GEN_ID(REPLICATE$REPLICATETABLES_ID, 1));
INSERT INTO REPLICATE$TABLES (TABLE_NAME, OPERATION, TRIGGER_NAME, SORT_ORDER, EXCLUDE_FIELDS, LOCAL_GENERATOR, REMOTE_GENERATOR, LOCAL_ID_COLUMN, INDICE_TYPE, OPTIONS, ID) VALUES ('SYSTEM_HOOK_NOTIFICATIONS', 'UPDATE', 'SYSTEM_HOOK_NOTIF', '1000', '', 'GEN_HOOK_ID', '', 'ID', '0', '0', GEN_ID(REPLICATE$REPLICATETABLES_ID, 1));


