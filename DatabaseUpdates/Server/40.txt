
ALTER TABLE WS_COUPONS ADD 
RESTRICT_USAGE CHAR(1);

UPDATE WS_COUPONS
SET RESTRICT_USAGE = 'N';


SET TERM ^ ;
ALTER PROCEDURE WSP_WS_COUPONS_PAGE (
    IPPAGESIZE Bigint,
    IPPAGENUMBER Bigint )
RETURNS (
    OPDISCOUNT_COUPON Varchar(30),
    OPEXPIRES Timestamp,
    OPISACTIVE Integer,
    OPDISCOUNT Integer,
    OPID Integer,
    OPFREE_PRODUCT Bigint,
    OPMAIN_PRODUCT Bigint,
    OPVOUCHER_TYPE Integer,
    OPVOUCHER_USAGE Integer,
    OPFREE_POSTAGE Char(1),
    OPMAX_USAGE Integer,
    OPMIN_SPEND Double precision,
    OPMEMBER_ID Bigint,
    OPSTART_DATE_TIME Timestamp,
    opRESTRICT_USAGE CHAR(1) )
AS
DECLARE VARIABLE vPAGENO BIGINT;
  DECLARE VARIABLE vCOUNTER BIGINT;
BEGIN
  IF (ipPAGENUMBER < 1) THEN
    EXCEPTION EXC_INVALID_PAGE_NUM;

  IF (ipPAGESIZE < 1) THEN
    EXCEPTION EXC_INVALID_PAGE_SIZE;

  vCOUNTER = 0;

  vPAGENO = (ipPAGESIZE * ipPAGENUMBER) - ipPAGESIZE;

  FOR SELECT DISCOUNT_COUPON, EXPIRES, ISACTIVE, DISCOUNT, ID, FREE_PRODUCT_CODE, MAIN_PRODUCT_CODE, VOUCHER_TYPE, VOUCHER_USAGE, FREE_POSTAGE, MAX_USAGE, MINIMUM_SPEND, MEMBER_ID, START_DATE_TIME, RESTRICT_USAGE
  FROM WS_COUPONS
  INTO :opDISCOUNT_COUPON, :opEXPIRES, :opISACTIVE, :opDISCOUNT, :opID, :opFREE_PRODUCT, :opMAIN_PRODUCT, :opVoucher_Type, :opVoucher_Usage, :opFREE_POSTAGE, :opMAX_USAGE, :opMIN_SPEND, :opMEMBER_ID, :opSTART_DATE_TIME, opRESTRICT_USAGE
  DO
  BEGIN
    IF ((vCOUNTER >= vPAGENO) AND (vCOUNTER < (vPAGENO + ipPAGESIZE))) THEN
    BEGIN
      SUSPEND;
    END

    vCOUNTER = vCOUNTER + 1;

    IF (vCOUNTER > (vPAGENO + ipPAGESIZE)) THEN
    BEGIN
      EXIT;
    END
  END
  
END^
SET TERM ; ^


SET TERM ^ ;
ALTER PROCEDURE WSP_WS_COUPONS_UPD (
    IPID Integer,
    IPDISCOUNT_COUPON Varchar(30),
    IPEXPIRES Timestamp,
    IPISACTIVE Integer,
    IPDISCOUNT Integer,
    IPFREEPRODUCT Bigint,
    IPMAINPRODUCT Bigint,
    IPVOUCHERTYPE Integer,
    IPFREEPOSTAGE Char(1),
    IPMAXUSAGE Integer,
    IPMINIMUMSPEND Double precision,
    IPSTART_DATE_TIME Timestamp,
    ipRESTRICT_USAGE CHAR(1) )
AS
BEGIN
  
  IF (NOT EXISTS(SELECT ID FROM WS_COUPONS WHERE ID = :ipID)) THEN
    EXCEPTION EXC_816002943;

  IF (ipDISCOUNT_COUPON IS NULL) THEN
    EXCEPTION EXC_816004153;

  UPDATE WS_COUPONS
  SET DISCOUNT_COUPON = :ipDISCOUNT_COUPON, 
     EXPIRES = :ipEXPIRES, 
     ISACTIVE = :ipISACTIVE, 
     DISCOUNT = :ipDISCOUNT,
     FREE_PRODUCT_CODE = :ipFREEPRODUCT,
     MAIN_PRODUCT_CODE = :ipMAINPRODUCT,
     VOUCHER_TYPE = :ipVOUCHERTYPE,
     FREE_POSTAGE = :ipFREEPOSTAGE,
     MAX_USAGE = :ipMAXUSAGE,
     MINIMUM_SPEND = :ipMINIMUMSPEND,
     START_DATE_TIME = :ipSTART_DATE_TIME,
     RESTRICT_USAGE = :ipRESTRICT_USAGE
  WHERE ID = :ipID;
 
END^
SET TERM ; ^







