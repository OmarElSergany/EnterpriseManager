CREATE GENERATOR GEN_DELETED_SKU_ID;

SET GENERATOR GEN_DELETED_SKU_ID TO 8000;

SET TERM ^ ;
CREATE OR ALTER TRIGGER TR_COST_SIZE_SOFT_DELETE_CHECK FOR WS_PRODUCTS_COST_SIZE ACTIVE
BEFORE UPDATE POSITION 0
AS 
  DECLARE VARIABLE vCount BIGINT;
BEGIN 
    IF (NEW.IS_DELETED = 'Y' AND OLD.IS_DELETED = 'N') THEN
    BEGIN
        SELECT SUM(a.TOTAL_AVAILABLE)
        FROM HS_STOCKCONTROL a
        WHERE a.ITEM_ID = NEW.ID
        INTO :vCount;
        
        IF (vCount > 0) THEN
        BEGIN
            EXCEPTION EXC_PROD_ITEM_DELETE 'Can not delete as stock exists';
        END
        
        DELETE FROM HS_STOCK_CREATE_SETTINGS scs
	    WHERE (scs.PRODUCT_ID = NEW.ID) OR (scs.SUB_PRODUCT_ID = NEW.ID);

        IF (SUBSTRING(NEW.SKU FROM 1 FOR 2) <> 'DE') THEN
            NEW.SKU = 'DE' || GEN_ID(GEN_DELETED_SKU_ID, 1);
    END
END^
SET TERM ; ^
